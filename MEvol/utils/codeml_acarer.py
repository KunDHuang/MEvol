#!/usr/bin/env python

import subprocess
from Bio.Phylo.PAML import codeml
import pandas as pd
import scipy.stats
import os
import sys
import argparse
import textwrap
import numpy as np
import random

"""
NAME: codeml_acarer.py
DESCRIPTION: codeml_acarer.py (codeml aftermath carer) is a script to parse all information generated by codeml analysis.
AUTHOR: Kun D. Huang
DATE: 10.02.2023
"""


class ATeam:
    """
    ATeam is an object to spit out codeml results in a readable way
    """
    
    def __init__(self, codeml_outfile):
        
        self.codeml_outfile = codeml_outfile
    
    def get_lnL(self, model_idx):
        
        codeml_parse = codeml.read(self.codeml_outfile)
        return codeml_parse['NSsites'][model_idx]['lnL']
    
    def get_omega(self, model_idx):

        codeml_parse = codeml.read(self.codeml_outfile)
        
        if model_idx == 0:
            return codeml_parse['NSsites'][model_idx]['parameters']['omega']
        
        elif model_idx == 1:
            
            omega_proportions = codeml_parse['NSsites'][model_idx]['parameters']['site classes']
            
            df = pd.DataFrame([[0, float(omega_proportions[0]['proportion'])], [1, float(omega_proportions[1]['proportion'])]],
                              columns = ['omega', 'proportion'])            
            return df
        
        elif model_idx == 2:
            
            omega_proportions = codeml_parse['NSsites'][model_idx]['parameters']['site classes']
            matrix = []
            for c in omega_proportions:
                omega = float(omega_proportions[c]['omega'])
                prop = float(omega_proportions[c]['proportion'])
                matrix.append([omega, prop])
                
            
            df = pd.DataFrame(matrix,
                              columns = ['omega', 'proportion'])
            
            return df
        
    def get_df(self, model_idx):
            
        parsed_codeml = open(self.codeml_outfile).readlines()
        counter = 0
        df_dict = {}
        for df in parsed_codeml:
            if "lnL(ntime:" in df:
                df = df.split(":")[2].replace(")", "").replace(" ", "")        
                df_dict[counter] = int(df)
                counter += 1
                
                
        return df_dict[model_idx] 
        
            
            
    
def chi2_test(lnl_m0, lnl_m1, df_0, df_1):
    chi2 = lnl_m1 - lnl_m0
    df_10 = df_1 - df_0
    sig_level = scipy.stats.chi2.ppf(1-.05, df = df_10)
    
    if chi2 > sig_level:
        return 1
    else:
        return 0
    

def parse_one_file(codeml_outfile):
    # codeml_outfile: One output file from codeml analysis
    # This function is to parse one codeml output file.
    
    ATeam_obj = ATeam(codeml_outfile)
    df_0 = ATeam_obj.get_df(0)
    df_1 = ATeam_obj.get_df(1)
    df_2 = ATeam_obj.get_df(2)
    lnl_0 = ATeam_obj.get_lnL(0)
    lnl_1 = ATeam_obj.get_lnL(1)
    lnl_2 = ATeam_obj.get_lnL(2)   

    M01_chi2 = chi2_test(lnl_0, lnl_1, df_0, df_1)
    M12_chi2 = chi2_test(lnl_1, lnl_2, df_1, df_2)
    
    M0_omega = ATeam_obj.get_omega(0)
    M1_omega = ATeam_obj.get_omega(1)
    M2_omega = ATeam_obj.get_omega(2)
    
    M0_df = pd.DataFrame([['M0', M0_omega, np.nan, np.nan]], columns = ['model', 'omega', 'proportion', 'chi2_sig'])
    M1_omega.insert(0, 'model', ['M01', 'M01'])
    M1_omega['chi2_sig'] = [M01_chi2, M01_chi2]
    M2_omega.insert(0, 'model', ['M12', 'M12', 'M12'])
    M2_omega['chi2_sig'] = [M12_chi2, M12_chi2, M12_chi2]
    
    M_df = pd.concat([M0_df, M1_omega, M2_omega])
    
    return M_df

        
if __name__ == "__main__":
    
    def read_args(args):
    # This function is to parse arguments

        parser = argparse.ArgumentParser(formatter_class=argparse.RawDescriptionHelpFormatter,
                                         description = textwrap.dedent('''\
                                         This program is to analyze codeml results.
                                         '''),
                                         epilog = textwrap.dedent('''\
                                         examples:
                                         '''))
        parser.add_argument('--codeml_output',
                        nargs = '?',
                        help = '',
                        type = str,
                        default = None)
        
        parser.add_argument('--output',
                        nargs = '?',
                        help = '',
                        type = str,
                        default = None)

        return vars(parser.parse_args())
    
    pars = read_args(sys.argv)
    
    if os.path.isfile(pars["codeml_output"]):
        
        codeml_opt_file = parse_one_file(pars["codeml_output"])
        codeml_opt_file.to_csv(pars['output'], sep = '\t', index = False)

    elif os.path.isdir(pars["codeml_output"]):
        
        codeml_opt_files = subprocess.getoutput("readlink -f {}/*".format(pars["codeml_output"])).split("\n")
        valid_files = [file for file in codeml_opt_files if os.stat(file).st_size != 0]
        empty_files = [file for file in codeml_opt_files if os.stat(file).st_size == 0]
        if len(empty_files) > 0:
            warning_opt = open(pars["output"] + ".warning", "w")
            warning_opt.write("problematic files mostly due to empty content:" + "\n")
            for empty_file in empty_files:
                warning_opt.write(empty_file + "\n")
            warning_opt.close()
        
        dfs = []     
        for file in valid_files:
            print(file)
            identifier = file.split("/")[-1].split(".")[0]
            df_ = parse_one_file(file)
            df_.insert(0, "id", [identifier] * len(df_))
            dfs.append(df_)
        
        concat_df = pd.concat(dfs)
        concat_df.to_csv(pars["output"], sep = "\t", index = False)
            
    
































